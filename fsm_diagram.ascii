╔═══════════════════════════════════════════════════════════════════════════╗
║                 СИМВОЛЬНЫЙ АВТОМАТ ПЕРЕДАТЧИКА UART                       ║
║                       (управляющий автомат)                               ║
╠═══════════════════════════════════════════════════════════════════════════╣
║                                                                           ║
║                              ┌─────────────────┐                          ║
║                              │     RESET       │                          ║
║                              └────────┬────────┘                          ║
║                                       │                                    ║
║                              ┌────────▼────────┐                          ║
║                     ┌────────│      IDLE       │────────┐                  ║
║                     │        │  (tx=1, busy=0) │        │                  ║
║                     │        └─────────────────┘        │                  ║
║                     │                                    │                  ║
║            action=1 │                          action=2..5                  ║
║            (запись) │                          (начало передачи)           ║
║                     │                                    │                  ║
║                     ▼                                    ▼                  ║
║        ┌─────────────────────────┐        ┌─────────────────────────┐      ║
║        │ Остаемся в IDLE         │        │    START_BIT            │      ║
║        │ (обновляем матрицу)     │        │   (tx=0, busy=1)        │      ║
║        └─────────────────────────┘        └──────────┬──────────────┘      ║
║                                                       │                     ║
║                                              div_counter++                  ║
║                                              пока < DIV-1                   ║
║                                                       │                     ║
║                                          div_counter = DIV-1                ║
║                                                       │                     ║
║                                        ┌──────────────▼──────────────┐      ║
║                                        │        DATA_BITS            │      ║
║                                        │ (tx=данные, busy=1)         │      ║
║                                        └──────────────┬──────────────┘      ║
║                                                       │                     ║
║                                              Передаем W битов               ║
║                                              bit_counter++                  ║
║                                              div_counter++                  ║
║                                                       │                     ║
║                                        ┌──────────────┼──────────────┐      ║
║                             PAR ≠ 0    │              │    PAR = 0    │      ║
║                                        ▼              ▼              │      ║
║                            ┌────────────────────┐ ┌────────────────────┐    ║
║                            │   PARITY_BIT       │ │     STOP_BIT       │    ║
║                            │ (tx=чётность)      │ │   (tx=1, busy=1)   │    ║
║                            └──────────┬─────────┘ └──────────┬─────────┘    ║
║                                        │                       │             ║
║                               div_counter++          div_counter++          ║
║                               пока < DIV-1           пока < DIV-1           ║
║                                        │                       │             ║
║                              div_counter=DIV-1      div_counter=DIV-1       ║
║                                        │                       │             ║
║                                        └───────────┬───────────┘             ║
║                                                    ▼                         ║
║                                        ┌────────────────────┐                ║
║                                        │     STOP_BIT       │                ║
║                                        │   (tx=1, busy=1)   │                ║
║                                        └──────────┬─────────┘                ║
║                                                   │                          ║
║                                          div_counter++                       ║
║                                          пока < DIV-1                        ║
║                                                   │                          ║
║                                       cells_sent < cells_to_send             ║
║                                                   │                          ║
║                                        ┌──────────┴──────────┐               ║
║                           ┌────────────┤                     ├──────────┐    ║
║                           │            │    NEXT_CELL        │          │    ║
║                           │            │ (обновить индексы)  │          │    ║
║                           │            └──────────┬──────────┘          │    ║
║                           │                       │                     │    ║
║               cells_sent = cells_to_send          │        ┌────────────┘    ║
║                           │                       ▼        │                 ║
║                           │            ┌────────────────────┐               ║
║                           └───────────▶│     START_BIT      │◀──────────────┘
║                                        │   (tx=0, busy=1)   │                 
║                                        └────────────────────┘                 
║                                                                           ║
║                                                                           ║
╚═══════════════════════════════════════════════════════════════════════════╝

ЛЕГЕНДА:
● IDLE - состояние покоя, ожидание команд
● START_BIT - передача стартового бита (0)
● DATA_BITS - передача битов данных
● PARITY_BIT - передача бита четности (если включено)
● STOP_BIT - передача стопового бита (1)
● NEXT_CELL - переход к следующей ячейке матрицы

УСЛОВНЫЕ ПЕРЕХОДЫ:
1. action=1 → запись в матрицу, остаемся в IDLE
2. action=2..5 → начало передачи, переход в START_BIT
3. div_counter достигает DIV-1 → переход к следующему состоянию
4. Все биты переданы → переход к STOP_BIT или PARITY_BIT
5. Все ячейки переданы → возврат в IDLE
6. Есть еще ячейки → переход в NEXT_CELL
